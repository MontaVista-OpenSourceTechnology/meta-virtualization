From a0d0f0ef68935338d2c710db164fa7820f692530 Mon Sep 17 00:00:00 2001
From: wheat2018 <1151937289@qq.com>
Date: Tue, 13 Aug 2024 15:56:31 +0800
Subject: [PATCH] fix goroutine leak of container Attach

The monitor goroutine (runs (*ContainerIO).Attach.func1) of Attach will
never finish if it attaches to a container without any stdout or stderr
output. Wait for http context cancel and break the pipe actively to
address the issue.

Signed-off-by: wheat2018 <1151937289@qq.com>
Signed-off-by: Akihiro Suda <akihiro.suda.cz@hco.ntt.co.jp>

Upstream-Status: Backport from [https://github.com/containerd/containerd/commit/a0d0f0ef68935338d2c710db164fa7820f692530]
CVE: CVE-2025-64329
Signed-off-by: Milan Satpathy <msatpathy@mvista.com>

---
 .../containerd/cri/pkg/server/container_attach.go  |  2 +-
 .../containerd/cri/pkg/server/io/container_io.go   | 14 +++++++++++---
 2 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/src/import/vendor/github.com/containerd/cri/pkg/server/container_attach.go b/src/import/vendor/github.com/containerd/cri/pkg/server/container_attach.go
index 91cdaac..f727faa 100644
--- a/src/import/vendor/github.com/containerd/cri/pkg/server/container_attach.go
+++ b/src/import/vendor/github.com/containerd/cri/pkg/server/container_attach.go
@@ -77,6 +77,6 @@ func (c *criService) attachContainer(ctx context.Context, id string, stdin io.Re
 		},
 	}
 	// TODO(random-liu): Figure out whether we need to support historical output.
-	cntr.IO.Attach(opts)
+	cntr.IO.Attach(ctx, opts)
 	return nil
 }
diff --git a/src/import/vendor/github.com/containerd/cri/pkg/server/io/container_io.go b/src/import/vendor/github.com/containerd/cri/pkg/server/io/container_io.go
index 7edf627..3885948 100644
--- a/src/import/vendor/github.com/containerd/cri/pkg/server/io/container_io.go
+++ b/src/import/vendor/github.com/containerd/cri/pkg/server/io/container_io.go
@@ -17,6 +17,7 @@ limitations under the License.
 package io
 
 import (
+	"context"
 	"errors"
 	"io"
 	"strings"
@@ -132,7 +133,7 @@ func (c *ContainerIO) Pipe() {
 
 // Attach attaches container stdio.
 // TODO(random-liu): Use pools.Copy in docker to reduce memory usage?
-func (c *ContainerIO) Attach(opts AttachOptions) {
+func (c *ContainerIO) Attach(ctx context.Context, opts AttachOptions) {
 	var wg sync.WaitGroup
 	key := util.GenerateID()
 	stdinKey := streamKey(c.id, "attach-"+key, Stdin)
@@ -173,8 +174,15 @@ func (c *ContainerIO) Attach(opts AttachOptions) {
 	}
 
 	attachStream := func(key string, close <-chan struct{}) {
-		<-close
-		logrus.Infof("Attach stream %q closed", key)
+		select {
+		case <-close:
+			logrus.Infof("Attach stream %q closed", key)
+		case <-ctx.Done():
+			logrus.Infof("Attach client of %q cancelled", key)
+			// Avoid writeGroup heap up
+			c.stdoutGroup.Remove(key)
+			c.stderrGroup.Remove(key)
+		}
 		// Make sure stdin gets closed.
 		if stdinStreamRC != nil {
 			stdinStreamRC.Close()
-- 
2.34.1


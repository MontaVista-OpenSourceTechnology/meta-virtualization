From 840c431af1f3a82f97ac129972a3cfae356e37e0 Mon Sep 17 00:00:00 2001
From: Vivek Kumbhar <vkumbhar@mvista.com>
Date: Wed, 14 Jun 2023 14:59:24 +0000
Subject: [PATCH] CVE-2021-4147

---
 src/libxl/libxl_logger.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/src/libxl/libxl_logger.c b/src/libxl/libxl_logger.c
index 1581a30..c2caf4a 100644
--- a/src/libxl/libxl_logger.c
+++ b/src/libxl/libxl_logger.c
@@ -28,6 +28,7 @@
 #include "util/virfile.h"
 #include "util/virhash.h"
 #include "util/virstring.h"
+#include "util/virthread.h"
 #include "util/virtime.h"
 
 #define VIR_FROM_THIS VIR_FROM_LIBXL
@@ -43,6 +44,7 @@ struct xentoollog_logger_libvirt {
 
     /* map storing the opened fds: "domid" -> FILE* */
     virHashTablePtr files;
+    virMutex tableLock;
     FILE *defaultLogFile;
 };
 
@@ -86,7 +88,9 @@ libvirt_vmessage(xentoollog_logger *logger_in,
         start = start + 9;
         *end = '\0';
 
+        virMutexLock(&lg->tableLock);
         domainLogFile = virHashLookup(lg->files, start);
+        virMutexUnlock(&lg->tableLock);
         if (domainLogFile)
             logFile = domainLogFile;
 
@@ -161,6 +165,11 @@ libxlLoggerNew(const char *logDir, virLogPriority minLevel)
 
     if ((logger.defaultLogFile = fopen(path, "a")) == NULL)
         goto error;
+    
+    if (virMutexInit(&logger.tableLock) < 0) {
+        VIR_FORCE_FCLOSE(logger.defaultLogFile);
+        return NULL;
+    }
 
     logger_out = XTL_NEW_LOGGER(libvirt, logger);
 
@@ -180,6 +189,7 @@ libxlLoggerFree(libxlLoggerPtr logger)
     if (logger->defaultLogFile)
         VIR_FORCE_FCLOSE(logger->defaultLogFile);
     virHashFree(logger->files);
+    virMutexDestroy(&logger->tableLock);
     xtl_logger_destroy(xtl_logger);
 }
 
@@ -202,7 +212,9 @@ libxlLoggerOpenFile(libxlLoggerPtr logger,
                  path, virStrerror(errno, ebuf, sizeof(ebuf)));
         goto cleanup;
     }
+    virMutexLock(&logger->tableLock);
     ignore_value(virHashAddEntry(logger->files, domidstr, logFile));
+    virMutexUnlock(&logger->tableLock);
 
     /* domain_config is non NULL only when starting a new domain */
     if (domain_config) {
@@ -221,7 +233,9 @@ libxlLoggerCloseFile(libxlLoggerPtr logger, int id)
     char *domidstr = NULL;
     domidstr = g_strdup_printf("%d", id);
 
+    virMutexLock(&logger->tableLock);
     ignore_value(virHashRemoveEntry(logger->files, domidstr));
+    virMutexUnlock(&logger->tableLock);
 
     VIR_FREE(domidstr);
 }
-- 
2.24.4


From e4116eaa44cb366b59f7fe98f4b88d04c04970ad Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?J=C3=A1n=20Tomko?= <jtomko@redhat.com>
Date: Fri, 18 Sep 2020 17:54:14 +0200
Subject: [PATCH] rpc: require write acl for guest agent in
 virDomainInterfaceAddresses
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

CVE-2020-25637

Add a requirement for domain:write if source is set to
VIR_DOMAIN_INTERFACE_ADDRESSES_SRC_AGENT.

Signed-off-by: JÃ¡n Tomko <jtomko@redhat.com>
Reported-by: Ilja Van Sprundel <ivansprundel@ioactive.com>
Reviewed-by: Jiri Denemark <jdenemar@redhat.com>

Upsteam-Status: Backport
CVE: CVE-2020-25637 
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 src/libxl/libxl_driver.c     | 2 +-
 src/lxc/lxc_driver.c         | 2 +-
 src/qemu/qemu_driver.c       | 2 +-
 src/remote/remote_protocol.x | 1 +
 4 files changed, 4 insertions(+), 3 deletions(-)

Index: libvirt-6.1.0/src/libxl/libxl_driver.c
===================================================================
--- libvirt-6.1.0.orig/src/libxl/libxl_driver.c
+++ libvirt-6.1.0/src/libxl/libxl_driver.c
@@ -6331,7 +6331,7 @@ libxlDomainInterfaceAddresses(virDomainP
     if (!(vm = libxlDomObjFromDomain(dom)))
         goto cleanup;
 
-    if (virDomainInterfaceAddressesEnsureACL(dom->conn, vm->def) < 0)
+    if (virDomainInterfaceAddressesEnsureACL(dom->conn, vm->def, source) < 0)
         goto cleanup;
 
     if (virDomainObjCheckActive(vm) < 0)
Index: libvirt-6.1.0/src/lxc/lxc_driver.c
===================================================================
--- libvirt-6.1.0.orig/src/lxc/lxc_driver.c
+++ libvirt-6.1.0/src/lxc/lxc_driver.c
@@ -1698,7 +1698,7 @@ lxcDomainInterfaceAddresses(virDomainPtr
     if (!(vm = lxcDomObjFromDomain(dom)))
         goto cleanup;
 
-    if (virDomainInterfaceAddressesEnsureACL(dom->conn, vm->def) < 0)
+    if (virDomainInterfaceAddressesEnsureACL(dom->conn, vm->def, source) < 0)
         goto cleanup;
 
     if (virDomainObjCheckActive(vm) < 0)
Index: libvirt-6.1.0/src/qemu/qemu_driver.c
===================================================================
--- libvirt-6.1.0.orig/src/qemu/qemu_driver.c
+++ libvirt-6.1.0/src/qemu/qemu_driver.c
@@ -21846,7 +21846,7 @@ qemuDomainInterfaceAddresses(virDomainPt
     if (!(vm = qemuDomainObjFromDomain(dom)))
         goto cleanup;
 
-    if (virDomainInterfaceAddressesEnsureACL(dom->conn, vm->def) < 0)
+    if (virDomainInterfaceAddressesEnsureACL(dom->conn, vm->def, source) < 0)
         goto cleanup;
 
     if (virDomainObjCheckActive(vm) < 0)
Index: libvirt-6.1.0/src/remote/remote_protocol.x
===================================================================
--- libvirt-6.1.0.orig/src/remote/remote_protocol.x
+++ libvirt-6.1.0/src/remote/remote_protocol.x
@@ -6211,6 +6211,7 @@ enum remote_procedure {
     /**
      * @generate: none
      * @acl: domain:read
+     * @acl: domain:write::source:VIR_DOMAIN_INTERFACE_ADDRESSES_SRC_AGENT
      */
     REMOTE_PROC_DOMAIN_INTERFACE_ADDRESSES = 353,
 

From 41b8642b91f755267c654def8471d24d030ec765 Mon Sep 17 00:00:00 2001
From: Vivek Kumbhar <vkumbhar@mvista.com>
Date: Wed, 11 Jan 2023 09:53:39 +0000
Subject: [PATCH] CVE-2021-21285

---
 distribution/pull_v2.go | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/distribution/pull_v2.go b/distribution/pull_v2.go
index 50257f5cb4..b7e5eea83a 100644
--- git/src/import/distribution/pull_v2.go
+++ git/src/import/distribution/pull_v2.go
@@ -459,6 +459,9 @@ func (p *v2Puller) pullSchema1(ctx context.Context, ref reference.Named, unverif
 	// to top-most, so that the downloads slice gets ordered correctly.
 	for i := len(verifiedManifest.FSLayers) - 1; i >= 0; i-- {
 		blobSum := verifiedManifest.FSLayers[i].BlobSum
+		if err = blobSum.Validate(); err != nil {
+			return "", "", errors.Wrapf(err, "could not validate layer digest %q", blobSum)
+		}
 
 		var throwAway struct {
 			ThrowAway bool `json:"throwaway,omitempty"`
@@ -545,6 +548,9 @@ func (p *v2Puller) pullSchema2(ctx context.Context, ref reference.Named, mfst *s
 	// Note that the order of this loop is in the direction of bottom-most
 	// to top-most, so that the downloads slice gets ordered correctly.
 	for _, d := range mfst.Layers {
+	        if err := d.Digest.Validate(); err != nil {
+			return "", errors.Wrapf(err, "could not validate layer digest %q", d.Digest)
+		}
 		layerDescriptor := &v2LayerDescriptor{
 			digest:            d.Digest,
 			repo:              p.repo,
-- 
2.18.2

